<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calibration</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href='https://fonts.googleapis.com/css?family=Dancing Script' rel='stylesheet'>
</head>
<body>
    <div class="background-image"></div>
    <div id="flash-messages">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {% if category == 'success' %}alert-success{% else %}alert-error{% endif %}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>    
    <nav>
        <a href='#' class="website-name">Dodgeball Throw Analyzer</a>
        <ul>
            <li class="{{ 'active' if request.endpoint == 'home' }}"><a href="/">Home</a></li>
            <li class="{{ 'active' if request.endpoint == 'my_page' }}"><a href="/my-page">My Page</a></li>
            <li class="{{ 'active' if request.endpoint == 'calibration' }}"><a href="/calibration">Calibration</a></li>
            <li class="{{ 'active' if request.endpoint == 'measure' }}"><a href="/measure">Measure Throw</a></li>
            <li class="{{ 'active' if request.endpoint == 'how_it_works' }}"><a href="/how-it-works">How does it work?</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            {% else %}
                <li><a href="{{ url_for('login', next=request.path) }}">Login</a></li>
            {% endif %}
        </ul>
    </nav>
    <div class="container">
        <h1>Calibration</h1>
        <p>Before you can accurately measure your dodgeball throws, you need to calibrate your camera setup. Calibration ensures that the measurements taken by our system are precise and tailored to your specific setup.</p>

        <h2>Calibration Process</h2>
        <p>Follow these steps to calibrate your camera setup:</p>
        <ol>
            <li style="margin-bottom: 4px;">Hold a dodgeball at the center of the target on the wall, making sure it is clearly visible from both cameras.</li>
            <li style="margin-bottom: 4px;">Take a photo of the dodgeball from each camera, making sure that the entire object is visible in the frame. Both cameras should capture the image at the same time.</li>
            <li style="margin-bottom: 4px;">Upload the calibration images from each camera using the form below.</li>
            <li>After uploading the images, our system will analyze the images and calculate the necessary calibration parameters for your camera setup.</li>
        </ol>
        <p>Once calibration is complete, you can proceed to measure your dodgeball throws.</p>
        <h2>Upload Calibration Images</h2>
        <form id="calibration-form" action="/calibration" method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="sideImage">Side Camera Image: </label>
                <input type="file" class="form-control-file" id="sideImage" name="sideImage" required>
                <small class="form-text text-muted" style="font-size: 10px;">(Accepted formats: .jpg, .jpeg, .png)</small>
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <label for="underneathImage">Bottom Camera:</label>
                <input type="file" class="form-control-file" id="underneathImage" name="underneathImage" required>
                <small class="form-text text-muted" style="font-size: 10px;">(Accepted formats: .jpg, .jpeg, .png)</small>
            </div>
            <!-- Add these lines inside the <form> element -->
            <!-- <div class="form-group" style="margin-top: 15px;">
                <label for="sideVideo">Side Camera Video: </label>
                <input type="file" class="form-control-file" id="sideVideo" name="sideVideo" required>
                <small class="form-text text-muted" style="font-size: 10px;">(Accepted formats: .mp4, .mov, .avi)</small>
            </div>
            <input type="hidden" id="center1" name="center1" value="">
            <input type="hidden" id="edge1" name="edge1" value="">
            <input type="hidden" id="center2" name="center2" value="">
            <input type="hidden" id="edge2" name="edge2" value="">

            <button type="submit" id="calibrate-btn">Calibrate</button>
        </form>
        <div id="side-image-container"></div>
        <div id="underneath-image-container"></div>
        {% if calibration_images %}
            <div class="calibration-images">
                <h2>Calibration Images</h2>
                <div class="calibration-image">
                    <canvas id="sideCanvas"></canvas>
                    <p>Side Camera Image</p>
                </div>
                <div class="calibration-image">
                    <canvas id="underCanvas"></canvas>
                    <p>Underneath Camera Image</p>
                </div>
            </div>
        {% endif %}
    </div>
    <script>
        function processImageClick(x, y, imageType) {
            console.log(`Clicked on ${imageType} image at (${x}, ${y})`);

            // Send the clicked coordinates to the server as query parameters
            fetch(`/calibration?x=${x}&y=${y}&image_type=${imageType}`)
            .then((response) => response.json())
            .then((result) => {
                const center1 = result.center1;
                const edge1 = result.edge1;
                const center2 = result.center2;
                const edge2 = result.edge2;

                setCoordinatesInputValues(center1, edge1, center2, edge2);
            })
            .catch((error) => {
                console.error('Error:', error);
            });
        }

        // ...rest of the JavaScript code...


        function setCoordinatesInputValues(center1, edge1, center2, edge2) {
            document.getElementById('center1').value = center1.join(',');
            document.getElementById('edge1').value = edge1.join(',');
            document.getElementById('center2').value = center2.join(',');
            document.getElementById('edge2').value = edge2.join(',');
        }
        function validateCoordinatesInputValues() {
            const center1 = document.getElementById('center1').value;
            const edge1 = document.getElementById('edge1').value;
            const center2 = document.getElementById('center2').value;
            const edge2 = document.getElementById('edge2').value;

            return center1 && edge1 && center2 && edge2;
        }

        function processImageClick(x, y, imageType) {
            console.log(`Clicked on ${imageType} image at (${x}, ${y})`);
            // TODO: Send the clicked coordinates to the server for processing

            // Replace this with actual logic to set the correct values
            const center1 = [100, 100];
            const edge1 = [200, 200];
            const center2 = [150, 150];
            const edge2 = [250, 250];

            setCoordinatesInputValues(center1, edge1, center2, edge2);
        }
        function drawImageOnCanvas(imageBase64, canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.src = `data:image/png;base64,${imageBase64}`;
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
            };
        }
        function initCanvasClickHandler(canvasId, callback) {
            const canvas = document.getElementById(canvasId);
            canvas.addEventListener('click', (event) => {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                callback(x, y);
            });
        }

        function processImageClick(x, y, imageType) {
            console.log(`Clicked on ${imageType} image at (${x}, ${y})`);
            // TODO: Send the clicked coordinates to the server for processing
        }
        function initFlashMessagesObserver() {
          const flashMessages = document.getElementById('flash-messages');
          const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
              if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                while (mutation.target.firstElementChild !== mutation.addedNodes[0]) {
                  mutation.target.firstElementChild.remove();
                }
              }
            });
          });
      
          observer.observe(flashMessages, { childList: true });
        }
      
        function addButtonLoader(button, form) {
            form.addEventListener('submit', function (event) {
                event.preventDefault();
                button.innerHTML += `<span class="loader-container"><div class="loader"></div></span>`;
                button.classList.add('loading');
                setTimeout(() => {
                    button.disabled = true;
                    form.submit();
                }, 100);
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            initFlashMessagesObserver();

            const calibrateBtn = document.getElementById('calibrate-btn');
            const calibrateForm = document.querySelector('form[method="POST"][action="/calibration"]');
            addButtonLoader(calibrateBtn, calibrateForm);

            const measureBtn = document.getElementById('measure-btn');
            const measureForm = document.querySelector('form[method="POST"][action="/measure"]');
            addButtonLoader(measureBtn, measureForm);

            {% if calibration_images %}
                drawImageOnCanvas('{{ calibration_images.side_image_base64 }}', 'sideCanvas');
                drawImageOnCanvas('{{ calibration_images.underneath_image_base64 }}', 'underCanvas');
                initCanvasClickHandler('sideCanvas', (x, y) => processImageClick(x, y, 'side'));
                initCanvasClickHandler('underCanvas', (x, y) => processImageClick(x, y, 'underneath'));
            {% endif %}
            calibrateForm.addEventListener('submit', function (event) {
                event.preventDefault();

                if (validateCoordinatesInputValues()) {
                    calibrateForm.submit();
                } else {
                    // Display an error message or handle the invalid input case
                    console.error('Invalid input values for calibration coordinates');
                }
            });
        });
        document.getElementById('calibrate-btn').addEventListener('click', (event) => {
            if (!validateCoordinatesInputValues()) {
                event.preventDefault();
                alert('Please click on both the center and edge of the dodgeball in both images.');
            }
        });
        window.onload = function() {
            const sideCanvas = document.getElementById('sideCanvas');
            const underCanvas = document.getElementById('underCanvas');

            if (sideCanvas && underCanvas) {
                const sideImage = new Image();
                const underImage = new Image();

                sideImage.src = '{{ calibration_images.side_image_url }}';
                underImage.src = '{{ calibration_images.underneath_image_url }}';

                sideImage.onload = function() {
                    drawImageWithClick(sideCanvas, sideImage, 'side');
                };
                underImage.onload = function() {
                    drawImageWithClick(underCanvas, underImage, 'underneath');
                };
            }
        };
    </script>
    <script>
        document.getElementById('calibration-form').addEventListener('submit', function(event) {
          event.preventDefault();
        
          // Create a FormData object to submit the form data
          var formData = new FormData(event.target);
        
          // Make an AJAX request to submit the form data
          fetch('{{ url_for("calibration") }}', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin',
            headers: {
              'X-CSRFToken': '{{ csrf_token() }}'
            }
          }).then(function(response) {
            if (response.ok) {
              return response.json();
            } else {
              throw new Error('An error occurred while submitting the form');
            }
          }).then(function(data) {
            // Display the uploaded images
            document.getElementById('side-image-container').innerHTML = `<img src="${data.side_image_url}" alt="Side image" />`;
            document.getElementById('underneath-image-container').innerHTML = `<img src="${data.underneath_image_url}" alt="Underneath image" />`;
          }).catch(function(error) {
            console.error('Error:', error);
          });
        });
    </script>        
</body>
</html> --> 

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calibration</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link href='https://fonts.googleapis.com/css?family=Dancing Script' rel='stylesheet'>
</head>
<body>
    <!-- Omitted navigation, flash messages and other elements for brevity -->
    <div class="background-image"></div>
    <div id="flash-messages">
        {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert {% if category == 'success' %}alert-success{% else %}alert-error{% endif %}" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>    
    <nav>
        <a href='#' class="website-name">Dodgeball Throw Analyzer</a>
        <ul>
            <li class="{{ 'active' if request.endpoint == 'home' }}"><a href="/">Home</a></li>
            <li class="{{ 'active' if request.endpoint == 'my_page' }}"><a href="/my-page">My Page</a></li>
            <li class="{{ 'active' if request.endpoint == 'calibration' }}"><a href="/calibration">Calibration</a></li>
            <li class="{{ 'active' if request.endpoint == 'measure' }}"><a href="/measure">Measure Throw</a></li>
            <li class="{{ 'active' if request.endpoint == 'how_it_works' }}"><a href="/how-it-works">How does it work?</a></li>
            {% if current_user.is_authenticated %}
                <li><a href="{{ url_for('logout') }}">Logout</a></li>
            {% else %}
                <li><a href="{{ url_for('login', next=request.path) }}">Login</a></li>
            {% endif %}
        </ul>
    </nav>
    <div class="container">
        <!-- Omitted other sections for brevity -->
        <h1>Calibration</h1>
        <p>Before you can accurately measure your dodgeball throws, you need to calibrate your camera setup. Calibration ensures that the measurements taken by our system are precise and tailored to your specific setup.</p>

        <h2>Calibration Process</h2>
        <p>Follow these steps to calibrate your camera setup:</p>
        <ol>
            <li style="margin-bottom: 4px;">Hold a dodgeball at the center of the target on the wall, making sure it is clearly visible from both cameras.</li>
            <li style="margin-bottom: 4px;">Take a photo of the dodgeball from each camera, making sure that the entire object is visible in the frame. Both cameras should capture the image at the same time.</li>
            <li style="margin-bottom: 4px;">Upload the calibration images from each camera using the form below.</li>
            <li>After uploading the images, our system will analyze the images and calculate the necessary calibration parameters for your camera setup.</li>
        </ol>
        <p>Once calibration is complete, you can proceed to measure your dodgeball throws.</p>
        <h2>Upload Calibration Images</h2>

        <form id="calibration-form" action="/calibration" method="POST"> <!-- enctype="multipart/form-data" -->
            {{ form.csrf_token }}
            <!-- Omitted other form elements for brevity -->
            <label for="side-image-input">Side Image:</label>
            <input type="file" id="side-image-input" name="side_image" accept="image/*"><br>
            <label for="underneath-image-input">Underneath Image:</label>
            <input type="file" id="underneath-image-input" name="underneath_image" accept="image/*"><br>

            <input type="hidden" id="center1" name="center1" value="">
            <input type="hidden" id="edge1" name="edge1" value="">
            <input type="hidden" id="center2" name="center2" value="">
            <input type="hidden" id="edge2" name="edge2" value="">
            <!-- <button type="submit" id="calibrate-btn">Calibrate</button> -->
            <button type="submit" id="calibrate-btn" disabled>Calibrate</button>

        </form>
        <div class="calibration-images">
            <h2>Calibration Images</h2>
            <div class="calibration-image">
                <canvas id="sideCanvas"></canvas>
                <p>Side Camera Image</p>
            </div>
            <div class="calibration-image">
                <canvas id="underCanvas"></canvas>
                <p>Underneath Camera Image</p>
            </div>
        </div>
    </div>
    <script>

        let sideClicks = 0;
        let underClicks = 0;

        function drawImageOnCanvas(imageSrc, canvasId, maxWidth, maxHeight) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            const img = new Image();

            img.onload = function () {
                const widthScaleFactor = maxWidth / img.width;
                const heightScaleFactor = maxHeight / img.height;
                const scaleFactor = Math.min(widthScaleFactor, heightScaleFactor);
                const newWidth = img.width * scaleFactor;
                const newHeight = img.height * scaleFactor;

                canvas.width = newWidth;
                canvas.height = newHeight;
                ctx.drawImage(img, 0, 0, newWidth, newHeight);
            };

            img.src = imageSrc;
        }

        function initCanvasClickHandler(canvasId, callback) {
            console.log('initCanvasClickHandler called');
            const canvas = document.getElementById(canvasId);
            canvas.addEventListener('click', (event) => {
                const rect = canvas.getBoundingClientRect();
                const x = event.clientX - rect.left;
                const y = event.clientY - rect.top;
                callback(x, y);
            });
        }

        function validateCoordinatesInputValues() {
            // Your existing code to validate the coordinates input values
            const center1 = document.getElementById('center1').value;
            const edge1 = document.getElementById('edge1').value;
            const center2 = document.getElementById('center2').value;
            const edge2 = document.getElementById('edge2').value;

            return center1 && edge1 && center2 && edge2;
        }

        function checkCalibrationReady() {
            // Check if both images have received two clicks and are uploaded
            const sideImageInput = document.getElementById('side-image-input');
            const underneathImageInput = document.getElementById('underneath-image-input');
            if (sideClicks === 2 && underClicks === 2 && sideImageInput.files.length > 0 && underneathImageInput.files.length > 0) {
                document.getElementById('calibrate-btn').disabled = false;
            }
        }
        function processImageClick(x, y, imageType) {
            if (imageType === 'side') {
                if (sideClicks === 0) {
                    document.getElementById('center1').value = `${x},${y}`;
                } else if (sideClicks === 1) {
                    document.getElementById('edge1').value = `${x},${y}`;
                }
                sideClicks++;
            } else if (imageType === 'underneath') {
                if (underClicks === 0) {
                    document.getElementById('center2').value = `${x},${y}`;
                } else if (underClicks === 1) {
                    document.getElementById('edge2').value = `${x},${y}`;
                }
                underClicks++;
            }
            checkCalibrationReady();
        }

        function loadImageFromFile(inputElement, canvasId) {
            console.log('loadImageFromFile called');
            const file = inputElement.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function () {
                    drawImageOnCanvas(img.src, canvasId);
                };
            };

            if (file) {
                reader.readAsDataURL(file);
            } else {
                // Clear the canvas if no file is selected
                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        function updateImages(sideImageBase64, underneathImageBase64) {
            drawImageOnCanvas("data:image/png;base64," + sideImageBase64, 'sideCanvas', 400, 400);
            drawImageOnCanvas("data:image/png;base64," + underneathImageBase64, 'underCanvas', 400, 400);
        }

        function checkImageFilesSelected() {
            // Check if both images have been selected
            const sideImageInput = document.getElementById('side-image-input');
            const underneathImageInput = document.getElementById('underneath-image-input');
            if (sideImageInput.files.length > 0 && underneathImageInput.files.length > 0) {
                document.getElementById('calibrate-btn').disabled = false;
            } else {
                document.getElementById('calibrate-btn').disabled = true;
            }
        }

        function submitFormWithImages() {
            const sideImageInput = document.getElementById('side-image-input');
            const underneathImageInput = document.getElementById('underneath-image-input');
            loadImageFromFile(sideImageInput, 'sideCanvas');
            loadImageFromFile(underneathImageInput, 'underCanvas');
            // Rest of the submit form code remains the same
        }

        document.getElementById('side-image-input').addEventListener('change', function () {
            loadImageFromFile(this, 'sideCanvas');
            initCanvasClickHandler('sideCanvas', (x, y) => processImageClick(x, y, 'side'));
            sideClicks = 0;
        });

        document.getElementById('underneath-image-input').addEventListener('change', function () {
            loadImageFromFile(this, 'underCanvas');
            initCanvasClickHandler('underCanvas', (x, y) => processImageClick(x, y, 'underneath'));
            underClicks = 0;
        });

        document.getElementById('calibrate-btn').addEventListener('click', (event) => {
            event.preventDefault();
            if (!validateCoordinatesInputValues()) {
                alert('Please click on both the center and edge of the dodgeball in both images.');
            } else {
                // Call the submit function here
                document.getElementById("calibration-form").submit();
            }
        });


        document.getElementById("calibration-form").addEventListener("submit", function (event) {
            event.preventDefault();
            const sideCanvas = document.getElementById('sideCanvas');
            const underCanvas = document.getElementById('underCanvas');
            const sideImageBlob = dataURLToBlob(sideCanvas.toDataURL('image/png'));
            const underImageBlob = dataURLToBlob(underCanvas.toDataURL('image/png'));
            
            const formData = new FormData(event.target);
            formData.append('sideImage', sideImageBlob, 'sideImage.png');
            formData.append('underneathImage', underImageBlob, 'underneathImage.png');

            // Submit the form using the modified FormData
            fetch('/calibration', {
                method: 'POST',
                body: formData,
            }).then(response => response.json())
            .then(data => {
                if (data.side_image_base64 && data.underneath_image_base64) {
                    updateImages(data.side_image_base64, data.underneath_image_base64);
                }
                // Handle the response data here
            });
        });

        function dataURLToBlob(dataURL) {
            const binary = atob(dataURL.split(',')[1]);
            const array = [];
            for (let i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            return new Blob([new Uint8Array(array)], { type: 'image/png' });
        }
    </script>
    {% if calibration_video %}
        <div class="calibration-video">
            <h2>Calibration Video</h2>
            <video width="640" height="360" controls>
                <source src="data:video/mp4;base64,{{ calibration_video }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <p>Calibration Process Video</p>
        </div>
    {% endif %}
</body>
</html> 
